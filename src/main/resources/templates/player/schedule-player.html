<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Schedule Player</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #0f172a; color: #e5e7eb; }
        .player-wrapper { max-width: 960px; margin: 0 auto; }
        .screen-frame {
            background: #020617;
            border-radius: 1rem;
            border: 3px solid #1f2937;
            padding: 1rem;
            min-height: 480px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        video, img {
            max-width: 100%;
            max-height: 100%;
            border-radius: 0.75rem;
        }
        .overlay-info {
            position: absolute;
            bottom: 0.75rem;
            left: 1rem;
            right: 1rem;
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            color: #d1d5db;
        }
    </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
    <div class="container-fluid">
        <a class="navbar-brand" th:href="@{/}">Screens Manager</a>
        <div class="navbar-nav">
            <a class="nav-link" th:href="@{/screens}">Screens</a>
            <a class="nav-link" th:href="@{/ads}">Ads</a>
            <a class="nav-link" th:href="@{/schedules}">Schedules</a>
        </div>
    </div>
</nav>

<div class="container player-wrapper"
     id="playerRoot"
     th:attr="data-schedule-id=${scheduleId}">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h2 class="text-light mb-1">Schedule player</h2>
            <p class="mb-0 text-muted">
                Ads will loop in order for this schedule.
            </p>
        </div>
        <button id="btnStart" class="btn btn-success btn-lg">
            ▶ Start loop
        </button>
    </div>

    <div class="screen-frame mb-3">
        <video id="videoPlayer" class="d-none" autoplay muted playsinline></video>
        <img id="imagePlayer" class="d-none" alt="Ad image">

        <div class="overlay-info">
            <div>
                <strong id="adTitle">Waiting…</strong><br>
                <small id="adInfo">Load playlist and press Start.</small>
            </div>
            <div>
                <small id="timerInfo">Idle</small>
            </div>
        </div>
    </div>

    <div class="bg-dark rounded-3 p-3">
        <h5>Playlist</h5>
        <p class="text-muted mb-2" id="playlistMeta">Loading playlist…</p>
        <ul class="list-group list-group-flush" id="playlistList"></ul>
    </div>

    <a th:href="@{/schedules}" class="btn btn-secondary mt-3">Back to schedules</a>
</div>

<script>
  const root = document.getElementById("playerRoot");
  const scheduleId = root.dataset.scheduleId;

  const videoPlayer = document.getElementById("videoPlayer");
  const imagePlayer = document.getElementById("imagePlayer");
  const adTitleEl = document.getElementById("adTitle");
  const adInfoEl = document.getElementById("adInfo");
  const timerInfoEl = document.getElementById("timerInfo");
  const playlistList = document.getElementById("playlistList");
  const playlistMeta = document.getElementById("playlistMeta");
  const btnStart = document.getElementById("btnStart");

  let playlist = [];
  let currentIndex = 0;
  let loopActive = false;
  let timerId = null;

  function loadPlaylist() {
    fetch(`/api/schedules/${scheduleId}/playlist`)
      .then(r => r.json())
      .then(data => {
        playlist = data.sort((a, b) => a.orderNr - b.orderNr);
        renderPlaylist();
      })
      .catch(err => {
        console.error(err);
        playlistMeta.textContent = "Failed to load playlist";
      });
  }

  function renderPlaylist() {
    playlistList.innerHTML = "";
    if (playlist.length === 0) {
      playlistMeta.textContent = "No items in this playlist.";
      return;
    }

    playlistMeta.textContent = `Items: ${playlist.length}`;
    playlist.forEach(item => {
      const li = document.createElement("li");
      li.className = "list-group-item bg-dark text-light d-flex justify-content-between";
      li.innerHTML = `
        <span>#${item.orderNr} — ${item.mimeType.startsWith("video/") ? "Video" : "Image"} / ${item.mediaDuration}s</span>
        <span class="text-muted small">adId: ${item.adId} | companyId: ${item.companyId}</span>
      `;
      playlistList.appendChild(li);
    });
  }

  function trackAdPlay(item) {
    fetch(`/api/ads/${item.adId}/track?seconds=${item.mediaDuration}`, {
      method: "POST"
    }).catch(err => console.error("Tracking failed", err));
  }

  function showItem(item) {
    adTitleEl.textContent = item.url.split("/").slice(-1)[0];
    adInfoEl.textContent = `${item.mimeType} • ${item.mediaDuration}s • adId ${item.adId} • companyId ${item.companyId}`;

    videoPlayer.classList.add("d-none");
    imagePlayer.classList.add("d-none");

    if (item.mimeType.startsWith("video/")) {
      videoPlayer.src = item.url;
      videoPlayer.currentTime = 0;
      videoPlayer.classList.remove("d-none");
      videoPlayer.play().catch(() => {});
    } else if (item.mimeType.startsWith("image/")) {
      imagePlayer.src = item.url;
      imagePlayer.classList.remove("d-none");
    }

    trackAdPlay(item);

    let remaining = item.mediaDuration;
    timerInfoEl.textContent = `Playing (${remaining}s left)`;

    if (timerId) clearInterval(timerId);
    timerId = setInterval(() => {
      remaining--;
      if (remaining <= 0) {
        clearInterval(timerId);
        timerInfoEl.textContent = "Switching…";
      } else {
        timerInfoEl.textContent = `Playing (${remaining}s left)`;
      }
    }, 1000);

    setTimeout(() => {
      if (!loopActive) return;
      currentIndex = (currentIndex + 1) % playlist.length;
      playCurrent();
    }, item.mediaDuration * 1000);
  }

  function playCurrent() {
    if (playlist.length === 0) return;
    showItem(playlist[currentIndex]);
  }

  btnStart.addEventListener("click", () => {
    if (playlist.length === 0) return;
    loopActive = !loopActive;

    if (loopActive) {
      btnStart.textContent = "⏸ Pause";
      currentIndex = 0;
      playCurrent();
    } else {
      btnStart.textContent = "▶ Start loop";
      timerInfoEl.textContent = "Paused";
      if (timerId) clearInterval(timerId);
      videoPlayer.pause();
    }
  });

  loadPlaylist();
</script>

</body>
</html>
